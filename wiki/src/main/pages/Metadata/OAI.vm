#* @vtlvariable name="doc" type="com.xpn.xwiki.api.Document" *# ##
#* @vtlvariable name="bcCurrentDoc" type="com.xpn.xwiki.api.Document" *# ##
## @vtlvariable name="asset" type="org.curriki.xwiki.plugin.asset.Asset" ##
## @vtlvariable name="document" type="com.xpn.xwiki.api.Document" ##
#* @vtlvariable name="xwiki" type="com.xpn.xwiki.api.XWiki" *# ##
#* @vtlvariable name="util" type="com.xpn.xwiki.api.Util" *# ##
#* @vtlvariable name="csm" type="org.curriki.plugin.spacemanager.impl.CurrikiSpaceManager" *# ##
#* @vtlvariable name="sm" type="org.curriki.plugin.spacemanager.impl.CurrikiSpaceManager" *# ##
#* @vtlvariable name="request" type="javax.servlet.http.HttpServletRequest" *# ##
#* @vtlvariable name="response" type="javax.servlet.http.HttpServletResponse" *# ##
#* @vtlvariable name="context" type="com.xpn.xwiki.api.Context" *# ##
#* @vtlvariable name="msg" type="com.xpn.xwiki.web.XWikiMessageTool" *# ##
#* @vtlvariable name="escapetool" type="org.apache.velocity.tools.generic.EscapeTool" *# ##
#* @vtlvariable name="datetool" type="org.apache.velocity.tools.generic.DateTool" *# ##
#* @vtlvariable name="numbertool" type="org.apache.velocity.tools.generic.NumberTool" *# ##
#* @vtlvariable name="searchi2g" type="net.i2geo.xwiki.impl.DefaultSearchI2GXWiki *# ##
##
#set($t=$xwiki.parseGroovyFromPage("${doc.space}.OAITool"))##
$t.init($context,$xwiki,$request,$response)##
$response.setContentType("text/xml")##
#set($baseURL="http://$xwiki.getXWiki().Param('curriki.system.hostname', 'i2geo.net')/api/oai-pmh")##
#if($t.hasError)##
$response.setStatus($t.statusCode, $t.statusMessage)
<?xml version="1.0" encoding="UTF-8"?>
<!-- generated by $baseURL on $datetool -->
<OAI-PMH xmlns="http://www.openarchives.org/OAI/2.0/"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://www.openarchives.org/OAI/2.0/
         http://www.openarchives.org/OAI/2.0/OAI-PMH.xsd">
    <responseDate>$t.date</responseDate>
    <request>$baseURL</request>
    <error code="$t.errorCode">$t.errorText</error>
</OAI-PMH>
##
## ----------------------- no error -------------------------------------
##
## ======================================================================
#elseif($t.verb=="Identify")
## ======================================================================
##
{pre}
<?xml version="1.0" encoding="UTF-8"?>
<!-- generated by $baseURL on $datetool -->
<OAI-PMH xmlns="http://www.openarchives.org/OAI/2.0/"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://www.openarchives.org/OAI/2.0/
         http://www.openarchives.org/OAI/2.0/OAI-PMH.xsd">
    <responseDate>$t.date</responseDate>
    <request verb="Identify">$baseURL</request>
    <Identify>
        <repositoryName>I2Geo repository</repositoryName>
        <baseURL>$baseURL</baseURL>
        <protocolVersion>2.0</protocolVersion>
        <adminEmail>webmaster@i2geo.net</adminEmail>
        <earliestDatestamp>2005-01-01T12:00:00Z</earliestDatestamp>
        <deletedRecord>no</deletedRecord>
        <granularity>YYYY-MM-DDThh:mm:ssZ</granularity>
        <description>
                <oai-identifier
                    xmlns="http://www.openarchives.org/OAI/2.0/oai-identifier"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://www.openarchives.org/OAI/2.0/oai-identifier http://www.openarchives.org/OAI/2.0/oai-identifier.xsd">
                <scheme>oai</scheme>
                <repositoryIdentifier>i2geo.net</repositoryIdentifier>
                <delimiter>:</delimiter>
                <sampleIdentifier>oai:Coll_polx:test</sampleIdentifier>
            </oai-identifier>
        </description>
    </Identify>
</OAI-PMH>
{/pre}
##
## ======================================================================
#elseif($t.verb=="ListMetadataFormats")
## ======================================================================
##
{pre}
<?xml version="1.0" encoding="UTF-8"?>
<!-- generated by $baseURL on $datetool -->
<OAI-PMH xmlns="http://www.openarchives.org/OAI/2.0/"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://www.openarchives.org/OAI/2.0/ http://www.openarchives.org/OAI/2.0/OAI-PMH.xsd">
    <responseDate>$t.date</responseDate>
    <request verb="ListMetadataFormats" #if($t.hasIdentifier)identifier="$t.identifier"#end>$baseURL</request>
    <ListMetadataFormats>
        <!-- not yet <metadataFormat>
            <metadataPrefix>oai_dc</metadataPrefix>
            <schema>http://www.openarchives.org/OAI/2.0/oai_dc.xsd</schema>
            <metadataNamespace>http://www.openarchives.org/OAI/2.0/oai_dc/
            </metadataNamespace>
        </metadataFormat> -->
        <metadataFormat>
            <metadataPrefix>i2glom</metadataPrefix>
            <schema>http://i2geo.net/ontologies/lomschema/lom-i2g-strict.xsd</schema>
            <metadataNamespace>http://ltsc.ieee.org/xsd/LOM</metadataNamespace>
        </metadataFormat>
    </ListMetadataFormats>
</OAI-PMH>
{/pre}
##
## ======================================================================
#elseif($t.verb=="ListSets")
## ======================================================================
##
{pre}
<?xml version="1.0" encoding="UTF-8"?>
<!-- generated by $baseURL on $datetool -->
<OAI-PMH xmlns="http://www.openarchives.org/OAI/2.0/"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://www.openarchives.org/OAI/2.0/
         http://www.openarchives.org/OAI/2.0/OAI-PMH.xsd">
    <responseDate>$t.date</responseDate>
    <request verb="ListSets">$baseURL</request>
    <error code="noSetHierarchy">This repository does not support sets</error>
</OAI-PMH>
{/pre}
##
## ======================================================================
#elseif($t.verb=="ListIdentifiers")
## ======================================================================
##
{pre}
<?xml version="1.0" encoding="UTF-8"?>
<!-- generated by $baseURL on $datetool -->
<OAI-PMH xmlns="http://www.openarchives.org/OAI/2.0/"
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://www.openarchives.org/OAI/2.0/ http://www.openarchives.org/OAI/2.0/OAI-PMH.xsd">
    <responseDate>$t.date</responseDate>
    <request verb="ListIdentifiers"
             #if($request.from)from="$t.from" #end
             #if($request.until)until="$t.until" #end
             >$baseURL</request>
    <ListIdentifiers>
        #foreach($item in $t.items())
            <header>
                <identifier>$item.identifier</identifier>
                <datestamp>$item.date</datestamp>
            </header>$t.throttle()
        #end
        #* #if($t.moreToCome)
            <resumptionToken expirationDate="2002-06-01T23:20:00Z"
                             completeListSize="6"
                             cursor="0">xxx45abttyz</resumptionToken>
        #end *#
    </ListIdentifiers>
</OAI-PMH>
{/pre}
##
## ======================================================================
#elseif($t.verb=="GetRecord")
## ======================================================================
##
{pre}
<?xml version="1.0" encoding="UTF-8"?>
<!-- generated by $baseURL on $datetool -->
<OAI-PMH xmlns="http://www.openarchives.org/OAI/2.0/"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://www.openarchives.org/OAI/2.0/ http://www.openarchives.org/OAI/2.0/OAI-PMH.xsd">
    <responseDate>$t.date</responseDate>
    <request verb="GetRecord" identifier="$t.identifier"
             metadataPrefix="$t.metadataPrefix">$baseURL</request>
    <GetRecord>
        <record>
            <header>
                <identifier>$t.identifier</identifier>
                <datestamp>$t.itemDate</datestamp>
            </header>
            <metadata>
                #if($t.metadataPrefix=="i2glom")
                #includeForm("${doc.space}.LOMMacro")
                #lom($t.asset)
                #end
            </metadata>
        </record>
    </GetRecord>
</OAI-PMH>
##
## ======================================================================
#elseif($t.verb=="ListRecords")
## ======================================================================
##
{pre}
<?xml version="1.0" encoding="UTF-8"?>
<!-- generated by $baseURL on $datetool -->
<OAI-PMH xmlns="http://www.openarchives.org/OAI/2.0/"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://www.openarchives.org/OAI/2.0/ http://www.openarchives.org/OAI/2.0/OAI-PMH.xsd">
    <responseDate>$t.date</responseDate>
    <request verb="ListRecords"
             #if($t.queryToResume) resumptionToken="$t.queryToResume.key"#end
             #if($request.from)from="$t.from" #end
             #if($request.until)until="$t.until" #end
             metadataPrefix="$t.metadataPrefix">$baseURL</request>
    #if($t.metadataPrefix=="i2glom")#includeForm("${doc.space}.LOMMacro")#end
    <ListRecords>
        #foreach($record in $t.records())
        <record>
            <header>
                <identifier>$record.identifier</identifier>
                <datestamp>$record.date</datestamp>
            </header>
            <metadata>
                #if($t.metadataPrefix=="i2glom")
            #lom($record.asset)
            #end
            </metadata>
        </record>
            $t.throttle()##
        #end
        #if($t.nextQuery)
            <resumptionToken expirationDate="$t.nextQuery.expirationDate" cursor="$t.nextQuery.cursor"
                             completeListSize="$t.nextQuery.idList.size()">$t.nextQuery.key</resumptionToken>
        #elseif($t.queryToResume)
            <resumptionToken ## expirationDate="$t.dateFormat.format($datetool.$t.nextQuery.created + $t.MAX_RESUMPTION_AGE)"
                    completeListSize="$t.queryToResume.idList.size()"/>
        #end
    </ListRecords>
</OAI-PMH>
#end