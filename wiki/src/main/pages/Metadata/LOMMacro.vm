## @vtlvariable name="asset" type="org.curriki.xwiki.plugin.asset.Asset" ##
#* @vtlvariable name="doc" type="com.xpn.xwiki.api.Document" *# ##
#* @vtlvariable name="bcCurrentDoc" type="com.xpn.xwiki.api.Document" *# ##
## @vtlvariable name="asset" type="org.curriki.xwiki.plugin.asset.Asset" ##
## @vtlvariable name="document" type="com.xpn.xwiki.api.Document" ##
#* @vtlvariable name="xwiki" type="com.xpn.xwiki.api.XWiki" *# ##
#* @vtlvariable name="util" type="com.xpn.xwiki.api.Util" *# ##
#* @vtlvariable name="csm" type="org.curriki.plugin.spacemanager.impl.CurrikiSpaceManager" *# ##
#* @vtlvariable name="sm" type="org.curriki.plugin.spacemanager.impl.CurrikiSpaceManager" *# ##
#* @vtlvariable name="request" type="javax.servlet.http.HttpServletRequest" *# ##
#* @vtlvariable name="response" type="javax.servlet.http.HttpServletResponse" *# ##
#* @vtlvariable name="context" type="com.xpn.xwiki.api.Context" *# ##
#* @vtlvariable name="msg" type="com.xpn.xwiki.web.XWikiMessageTool" *# ##
#* @vtlvariable name="escapetool" type="org.apache.velocity.tools.generic.EscapeTool" *# ##
#* @vtlvariable name="datetool" type="org.apache.velocity.tools.generic.DateTool" *# ##
#* @vtlvariable name="numbertool" type="org.apache.velocity.tools.generic.NumberTool" *# ##
#* @vtlvariable name="searchi2g" type="net.i2geo.xwiki.impl.DefaultSearchI2GXWiki *# ##
## init
#set($searchi2g=$xwiki.searchi2g)##
#set($geoskillsNS="http://www.inter2geo.eu/2008/ontology/GeoSkills")##
##
## utilities
#macro(annotation $eltName $value)##
    #if("$!value"!="")
    <$eltName><source>LOMv1.0</source> <value>$value</value></$eltName>
    #end
#end
#macro(ictEduType $ictName $interactivityType $learningResourceType $interactivityLevel $intendedUserRole)
<!-- educational annotations from Curriki's ICT $ictName
##    #annotation("interactivityType" $interactivityType)
##    #annotation("learningResourceType" $learningResourceType)
##    #annotation("interactivityLevel" $interactivityLevel)
##    #annotation("intendedEndUserRole" $intendedEndUserRole)
    #if("$!interactivityType"!="")$interactivityTypes.add($interactivityType)#end
    #if("$!learningResourceType"!="")$learningResourceTypes.add($learningResourceType)#end
    #if("$!interactivityLevel"!="")$interactivityLevels.add($interactivityLevel)#end
    #if("$!intendedEndUserRole"!="")$intendedEndUserRoles.add($intendedEndUserRole)#end -->
#end
#macro(vcard $userObject)##
BEGIN:VCARD&#xD;&#xA;##
VERSION:4.0&#xD;&#xA;##
FN:$escapetool.xml("$userObject.get('first_name') $userObject.get('last_name')")&#xD;&#xA;##
N:$escapetool.xml("$userObject.get('last_name');$userObject.get('first_name')");;;##
&#xD;&#xA;END:VCARD##
#end
##
## actual macro
#macro(lom $asset)
    ## #set($lang=$msg.get("languages3_2.$asset.getDocument().getObject('CurrikiCode.AssetClass').get('language').getValue()"))##
<!--
    #set($lang=$asset.getDocument().getObject('CurrikiCode.AssetClass').getField("language").getValue().toString())
    #if($lang=="English")#set($lang="en")
        #elseif($lang=="Español")#set($lang="es")
        #elseif($lang=="Bahasa Indonesia")#set($lang=$msg.get("languages3_2.ind"))
        #elseif($lang=="Chinese")#set($lang="zh")
        #elseif($lang=="Dutch" || $lang=="Nederlands")#set($lang="nl")
        #elseif($lang=="Français")#set($lang="fr")
        #elseif($lang=="German" || $lang=="Nederlands")#set($lang="nl")
        #elseif($lang=="Italian" || $lang=="Italiano")#set($lang="it")
        #elseif($lang=="Portugese") #set($lang="pt")
        #elseif($lang=="Russian")#set($lang="ru")
        #elseif($lang=="Chinese")#set($lang="zh")
        #elseif($lang.endsWith("tina"))#set($lang="cs")
        #elseif($lang.length()==3) #set($lang=$msg.get("languages3_2.${lang}"))
    #end
    #if("$!lang"=="" || $lang.length()!=2)broken language: $lang, using English instead #set($lang="en")#end
    #set($lomSchemaLocation="http://i2geo.net/ontologies/lomschema/lom-i2g.xsd")
    #if("$!request.lomSchemaLocation"!="")#set($lomSchemaLocation=$request.lomSchemaLocation)#end
     language? $lang --> ##
     ## $xwiki.getDocument($asset.fullName).getDocument().getObject('CurrikiCode.AssetClass').getField("language").getValue().toString()
     ##   #set($lang =$asset.get('language'))
    ## #set($lang=$msg.get("languages3_2.${lang}"))##
{pre}
<lom xmlns="http://ltsc.ieee.org/xsd/LOM"  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://ltsc.ieee.org/xsd/LOM ${lomSchemaLocation}">
    <general><!-- 1: General -->
        <identifier>
            <catalog>i2g</catalog><entry>$asset.fullName</entry>
        </identifier>
        <title>
            <string language="$lang">$escapetool.xml($asset.title)</string>
        </title>
        <language>$lang</language>
        <description>
            <string language="$lang">$escapetool.xml($asset.get("description"))</string>
        </description>
        <keyword>
            <string language="$lang">$escapetool.xml($asset.get("keywords"))</string>
            <!-- ttac = $asset.get("trainedTopicsAndCompetencies") -->
            #foreach($top in $asset.get("trainedTopicsAndCompetencies").split(","))##
                #set($names=$searchi2g.listNames($top))##
                #foreach($lang in $names.supportedLanguages)
                    #foreach($name in $names.getAllNamesFor($lang))
            <string language="$lang">$escapetool.xml($name)</string>
                    #end
                #end
            #end

        </keyword>
    </general>
    <lifeCycle>
        #set($creator=$xwiki.getDocument($asset.creator).getObject("XWiki.XWikiUsers"))##
        ## <!-- creator is $creator of class $creator.getClass() -->
        #set($lastAuthor=$xwiki.getDocument($asset.author).getObject("XWiki.XWikiUsers"))##
        #set($v=$asset.version)##
        #set($p=$v.indexOf('.'))#set($v1=$v.substring(0,$p))#set($v2=$v.substring($mathtool.add($p,1)))#set($v2=$numbertool.format("00",$numbertool.toNumber($v2)))##
        <version><string language="en">${v1}.${v2}</string></version>
        <status><source>LOMv1.0</source><value>revised</value></status>
        <contribute>
            <role><source>LOMv1.0</source><value>initiator</value></role>
            <entity>#vcard($creator)</entity>
            <date>
                <dateTime>$datetool.format("yyyy-MM-dd'T'HH:mm:ss.SSS'Z'",$asset.creationDate)</dateTime>
            </date>
        </contribute>
        <contribute>
            <role><source>LOMv1.0</source><value>editor</value></role>
            <entity>#vcard($lastAuthor)
            </entity>
            <date>
                <dateTime>$datetool.format("yyyy-MM-dd'T'HH:mm:ss.SSS'Z'",$asset.date)</dateTime>
            </date>
        </contribute>
    </lifeCycle>

    <technical>
        #if($asset.hasA("CurrikiCode.AttachmentAssetClass"))$asset.use("CurrikiCode.AttachmentAssetClass")##
            <format>$asset.get("file_type")</format>
            <size>$asset.get("file_size")</size>
            ## <location>http://$xwiki.getXWiki().Param('curriki.system.hostname', 'i2geo.net')/xwiki/bin/download/$asset.space/$asset.name/$asset.getAttachmentList().get(0).filename</location>
            <!-- THINKME: OS requirements? could derive form DGS format, see examples   <requirement>-->
        #end
        <location>http://$xwiki.getXWiki().Param('curriki.system.hostname', 'i2geo.net')/$asset.space/$asset.name</location>
    </technical>

    <educational>
        $asset.use("CurrikiCode.AssetClass")##
        #set($icts = $!asset.getValue("instructional_component"))
        #set($interactivityTypes=[])#set($learningResourceTypes=[])#set($interactivityLevels=[])#set($intendedUserRoles=[])##
        #foreach($ict in $icts)
            #set($ict=$ict.toString())
            #if($ict.startsWith("activity_"))
                 #if($ict.endsWith("_assignment"))         #ictEduType($ict "active"    "exercise" "" "learner")
                 #elseif($ict.endsWith("_exercise"))        #ictEduType($ict "active"    "exercise" "" "learner")
                 #elseif($ict.endsWith("_lab"))             #ictEduType($ict "active"    "other" "" "learner")
                 #elseif($ict.endsWith("_game"))           #ictEduType($ict "active"    "drill and practice" "high" "learner")
                 #elseif($ict.endsWith("_worksheet"))      #ictEduType($ict "active"    "exercise" "" "learner")
                 #elseif($ict.endsWith("_problemset"))     #ictEduType($ict "active"    "exercise" "" "learner")
                 #elseif($ict.endsWith("_webquest"))       #ictEduType($ict "acctive"   "investigation" "medium" "learner")
                 #elseif($ict.endsWith("_"))       #ictEduType($ict "" "" "" "")
                 #elseif($ict.endsWith("_"))       #ictEduType($ict "" "" "" "")
                 #elseif($ict.endsWith("_"))       #ictEduType($ict "" "" "" "")
                 #elseif($ict.endsWith("_"))       #ictEduType($ict "" "" "" "")
                 #elseif($ict.endsWith("_"))       #ictEduType($ict "" "" "" "")
                 #elseif($ict.endsWith("_"))       #ictEduType($ict "" "" "" "")
                 #elseif($ict.endsWith("_"))       #ictEduType($ict "" "" "" "")
                 #end
            #elseif($ict.startsWith("book_"))
                #if($ict.endsWith("_fiction"))          #ictEduType($ict "expositive"   "textbook" "" "")
                #elseif($ict.endsWith("_nonfiction"))   #ictEduType($ict "expositive"   "textbook" "" "")
                #elseif($ict.endsWith("_readings"))     #ictEduType($ict "expositive"   "textbook" "" "")
                #elseif($ict.endsWith("_textbook"))     #ictEduType($ict "expositive"   "textbook" "" "learner")
                #end
            #elseif($ict.startsWith("curriculum_"))
                #if($ict.endsWith("_assessment"))       #ictEduType($ict "active"       "assessment" "" "learner")
                #elseif($ict.endsWith("_course"))       #ictEduType($ict "mixed"        "lesson plan" "" "")
                #elseif($ict.endsWith("_lp"))           #ictEduType($ict ""             "lesson plan" "" "teacher")
                #elseif($ict.endsWith("_scope"))        #ictEduType($ict ""             "other" "" "")
                #elseif($ict.endsWith("_standards"))    #ictEduType($ict "expositive"   "other" "very low" "manager")
                #elseif($ict.endsWith("_studyguide"))   #ictEduType($ict "expositive"   "other" "very low" "learner")
                #elseif($ict.endsWith("_syllabus"))     #ictEduType($ict "expositive"   "lecture" "" "")
                #elseif($ict.endsWith("_tutorial"))     #ictEduType($ict "expositive"   "guide" "" "learner")
                #elseif($ict.endsWith("_unit"))         #ictEduType($ict ""             "lesson plan" "" "teacher")
                #elseif($ict.endsWith("_workbook"))     #ictEduType($ict "active"       "drill and practice" "medium" "learner")
                #end
            #elseif($ict.startsWith("resource_"))
                #if($ict.endsWith("_animation"))        #ictEduType($ict ""             "demonstration" "medium" "")
                #elseif($ict.endsWith("_article"))      #ictEduType($ict "expositive"   "text" "very low" "")
                #elseif($ict.endsWith("_speech"))       #ictEduType($ict "expositive"   "audio" "very low" "")
                #elseif($ict.endsWith("_diagram"))      #ictEduType($ict "expositive"   "image" "very low" "")
                #elseif($ict.endsWith("_glossary"))     #ictEduType($ict "expositive"   "glossaries" "medium" "")
                #elseif($ict.endsWith("_index"))        #ictEduType($ict "expositive"   "reference" "medium" "")
                #elseif($ict.endsWith("_photograph"))   #ictEduType($ict "expositive"   "image" "" "")
                #elseif($ict.endsWith("_collection"))   #ictEduType($ict "expositive"   "other" "" "")
                #elseif($ict.endsWith("_script"))       #ictEduType($ict ""             "text" "" "learner")
                #elseif($ict.endsWith("_study"))        #ictEduType($ict "expositive"   "text" "very low" "")
                #elseif($ict.endsWith("_table"))        #ictEduType($ict "expositive"   "data" "very low" "")
                #elseif($ict.endsWith("_template"))     #ictEduType($ict ""             "reference" "medium" "")
                #elseif($ict.endsWith("_presentation")) #ictEduType($ict "expositive"   "presentation" "very low" "")
                #elseif($ict.endsWith("_webcast"))      #ictEduType($ict "expositive"   "video" "" "learner")
                ## #elseif($ict.endsWith("_"))             #ictEduType($ict "" "" "" "")
                #end
            #elseif($ict == "other")
                #ictEduType($ict "" "" "" "")
            #end
        #end

        #foreach($l in $interactivityTypes)#annotation("interactivityType" $l)#end
        #foreach($l in $learningResourceTypes)#annotation("learningResourceType" $l)#end
        #foreach($l in $interactivityLevels)#annotation("interactivityLevel" $l)#end
        #foreach($l in $intendedUserRoles)#annotation("intendedEndUserRole" $l)#end

        <!-- i2g-context: as precise as possible but not interoperable
            #foreach($level in $asset.get("eduLevelFine").split(","))##
            <context><source>i2g</source>##
                <value>$geoskillsNS$level</value>
            </context>
            #set($names=$searchi2g.listNames($level))##
            #foreach($lang in $names.supportedLanguages)
                #foreach($name in $names.getAllNamesFor($lang))
                <context><source>i2g</source>
                    <value >$name</value>## language="$lang"
                </context>
                #end
            #end
            #end -->
        #set($modes=["context","ageRange"])
        #foreach($mode in $modes)
        #foreach($level in $asset.get("eduLevelFine").split(","))##
            #set($typicalAgeRange=$xwiki.searchi2g.getLevelAge($level))#set($t2=$typicalAgeRange+1)##
            #if($typicalAgeRange!=-1 && $typicalAgeRange!=0)<!-- typicalAgeRange is: $typicalAgeRange -->
                #if($mode=="context")
                #if($typicalAgeRange<11)##
                <context><source>LOMv1.0</source><value>primary education</value></context>
                #else##
                <context><source>LOMv1.0</source><value>secondary education</value></context>
                #end
                #elseif($mode=="ageRange")
                <typicalAgeRange><string language="en">${typicalAgeRange}-${t2}</string></typicalAgeRange>
                #end
            #end
        #end
        #end

        <language>$lang</language>


    ## <!-- really? -->
    ## <difficulty> <source>i2g</source><value>easy</value> </difficulty>
    </educational>

    <rights>
        <cost><source>LOMv1.0</source> <value>no</value> </cost>
        <copyrightAndOtherRestrictions> <source>LOMv1.0</source> <value>yes</value> </copyrightAndOtherRestrictions>
        #set($licenseType=$asset.getDocument().getObject('CurrikiCode.AssetLicenseClass').get('licenseType').getValue())##
        #if($licenseType=="Licences.CurrikiLicense")##
            <description><string language="en">$msg.get("CurrikiCode.AssetLicenseClass_licenseType_Licences.CurrikiLicense")</string></description>
            <!-- <licenseURI>http://creativecommons.org/licenses/by/3.0/</licenseURI> -->
        #elseif($licenseType=="Licences.PublicDomain")##
            <description><string language="en">$msg.get("CurrikiCode.AssetLicenseClass_licenseType_Licences.PublicDomain")</string></description>
            <!-- <licenseURI>http://creativecommons.org/licenses/publicdomain/</licenseURI> -->
        ###
        #elseif($licenseType=="Licences.CreativeCommonsAttributionNoDerivatives")##
            <description><string language="en">$msg.get("CurrikiCode.AssetLicenseClass_licenseType_Licences.Licences.CreativeCommonsAttributionNoDerivatives")</string></description>
            <!-- <licenseURI>http://creativecommons.org/licenses/by-nd/2.0/</licenseURI> -->
        ###
        #elseif($licenseType=="Licences.CreativeCommonsAttributionNon-Commercial")##
            <description><string language="en">$msg.get("CurrikiCode.AssetLicenseClass_licenseType_Licences.Licences.CreativeCommonsAttributionNon-Commercial")</string></description>
            <!-- <licenseURI>http://creativecommons.org/licenses/by-nc/2.0/</licenseURI>-->
        #elseif($licenseType=="Licences.CreativeCommonsAttributionNon-CommercialNoDerivatives")##
            <description><string language="en">$msg.get("CurrikiCode.AssetLicenseClass_licenseType_Licences.Licences.CreativeCommonsAttributionNon-CommercialNoDerivatives")</string></description>
            <!-- <licenseURI>http://creativecommons.org/licenses/by-nc-nd/2.0/</licenseURI> -->
        ###
        #elseif($licenseType=="Licences.CreativeCommonsAttributionSharealike")##
            <description><string language="en">$msg.get("CurrikiCode.AssetLicenseClass_licenseType_Licences.CreativeCommonsAttributionSharealike")</string></description>
            <!-- <licenseURI>http://creativecommons.org/licenses/by-sa/2.0/</licenseURI>-->
        ###
        #elseif($licenseType=="Licences.CreativeCommonsAttributionNon-CommercialShareAlike")##
            <description><string language="en">$msg.get("CurrikiCode.AssetLicenseClass_licenseType_Licences.Licences.CreativeCommonsAttributionNon-CommercialShareAlike")</string></description>
            <!-- <licenseURI>http://creativecommons.org/licenses/by-nc-sa/2.0/</licenseURI>-->
        ###
        #elseif($licenseType=="GFDL")##
            <description><string language="en">$msg.get("CurrikiCode.AssetLicenseClass_licenseType_Licences.GFDL")</string></description>
            <!-- <licenseURI>http://www.gnu.org/copyleft/fdl.html</licenseURI>-->
        #else <!-- unrecognized license type: "$licenseType" -->
        #end
    </rights>

    #* <annotation><!-- TODO: iterate over reviews -->
        <!-- <entity>http://draft.i2geo.net/xwiki/bin/view/QR/Coll_Fred__ProprieteDeLaireDuTriangle2_2</entity>
        <date><dateTime>2008-06-20T14:23:00</dateTime></date>
        <quality>90</quality>
        <numEvaluations>1</numEvaluations> -->
    </annotation> ## *#

    #if("$asset.get('trainedTopicsAndCompetencies')"!="")
    <classification>
        <purpose>
            <source>LOMv1.0</source>
            <value>educational objective</value>
        </purpose>
        <taxonPath><source><string language="en">$geoskillsNS</string></source>
            #foreach($top in $asset.get("trainedTopicsAndCompetencies").split(","))##
                #if($top.trim()!="")
                <taxon>
                    <id>$geoskillsNS$top</id>
                    <entry>
                    #set($names=$searchi2g.listNames($top))##
                    #set($hasName=false)##
                    #foreach($lang in $names.supportedLanguages)
                      #foreach($name in $names.getAllNamesFor($lang))
                      <string language="$lang">$escapetool.xml($name)</string>#set($hasName=true)
                      #end
                    #end
                    #if(!$hasName)<string language="en"><!-- fallback from URI -->$top.replaceAll("#|_"," ")</string>#end
                    </entry>
                </taxon>
                #end
            #end
        </taxonPath>
    </classification>
    #end
</lom>
{/pre}
#end